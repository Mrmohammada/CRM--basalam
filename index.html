<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM غرفه باسلام من (اتوماتیک با Webhook)</title>
    <!-- Bootstrap CSS از CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- localStorageDB از CDN (برای تست محلی) -->
    <script src="https://cdn.jsdelivr.net/npm/localstoragedb@1.2.4/local_storage_db.min.js"></script>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <h1 class="text-center mb-4">CRM غرفه باسلام (اتوماتیک)</h1>
        <p class="text-center text-muted">مشتری‌ها و سفارش‌ها از webhook باسلام اضافه می‌شن. دستی هم می‌تونی اضافه کنی.</p>
        
        <!-- تب‌ها -->
        <ul class="nav nav-tabs" id="crmTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers" type="button">مشتری‌ها</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button">سفارش‌ها</button>
            </li>
        </ul>
        
        <div class="tab-content mt-3">
            <!-- تب مشتری‌ها -->
            <div class="tab-pane fade show active" id="customers" role="tabpanel">
                <h3>لیست مشتری‌ها (اتوماتیک از باسلام)</h3>
                <form id="customerForm" class="mb-3">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="firstName" placeholder="نام" required>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="lastName" placeholder="نام خانوادگی" required>
                        </div>
                        <div class="col-md-4">
                            <input type="tel" class="form-control" id="phone" placeholder="شماره تلفن" required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">اضافه دستی</button>
                        </div>
                    </div>
                </form>
                <table class="table table-striped" id="customersTable">
                    <thead><tr><th>ID</th><th>نام</th><th>نام خانوادگی</th><th>تلفن</th><th>عملیات</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- تب سفارش‌ها -->
            <div class="tab-pane fade" id="orders" role="tabpanel">
                <h3>لیست سفارش‌ها (اتوماتیک از باسلام)</h3>
                <form id="orderForm" class="mb-3">
                    <div class="row">
                        <div class="col-md-3">
                            <select class="form-select" id="customerSelect" required>
                                <option value="">انتخاب مشتری</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="orderDesc" placeholder="توضیح سفارش" required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="orderAmount" placeholder="مبلغ" required>
                        </div>
                        <div class="col-md-2">
                            <input type="date" class="form-control" id="orderDate" value="" required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">اضافه دستی</button>
                        </div>
                    </div>
                </form>
                <table class="table table-striped" id="ordersTable">
                    <thead><tr><th>ID</th><th>مشتری</th><th>توضیح</th><th>مبلغ</th><th>تاریخ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS از CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // برای تست محلی: localStorageDB
        // برای webhook: API_BASE رو uncomment کن و local رو کامنت کن
        const API_BASE = ''; // 'https://your-worker.workers.dev'; // بعداً ست کن
        const USE_API = API_BASE !== ''; // اگر API_BASE خالی، از local استفاده کن

        let db;

        async function initDB() {
            if (USE_API) {
                // برای Cloudflare: مستقیم لود کن
                await loadCustomers();
                await loadOrders();
                await updateCustomerSelect();
            } else {
                // localStorageDB برای GitHub Pages
                db = new localStorageDB("basalamCRM", localStorage);
                if (db.isNew()) {
                    db.createTable("customers", ["first_name", "last_name", "phone"]);
                    db.createTable("orders", ["customer_id", "description", "amount", "date"]);
                    db.commit();
                }
                loadCustomers();
                loadOrders();
                updateCustomerSelect();
            }
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
        }

        // لود مشتری‌ها
        async function loadCustomers() {
            let customers;
            if (USE_API) {
                const res = await fetch(`${API_BASE}/api/customers`);
                customers = await res.json();
            } else {
                customers = db.queryAll("customers");
            }
            const tbody = document.querySelector('#customersTable tbody');
            tbody.innerHTML = '';
            customers.forEach(customer => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${customer.id || customer.ID}</td>
                    <td>${customer.first_name || customer.first_name}</td>
                    <td>${customer.last_name || customer.last_name}</td>
                    <td>${customer.phone}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer.id || customer.ID}')">حذف</button></td>
                `;
            });
        }

        // اضافه مشتری (دستی)
        document.getElementById('customerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phone = document.getElementById('phone').value;
            if (USE_API) {
                await fetch(`${API_BASE}/api/customers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ first_name: firstName, last_name: LastName, phone })
                });
            } else {
                const id = 'manual_' + Date.now();
                db.insert("customers", { ID: id, first_name: firstName, last_name: lastName, phone: phone });
                db.commit();
            }
            loadCustomers();
            updateCustomerSelect();
            this.reset();
        });

        // حذف مشتری
        async function deleteCustomer(id) {
            if (USE_API) {
                await fetch(`${API_BASE}/api/customers?id=${id}`, { method: 'DELETE' });
            } else {
                db.deleteRows("customers", { ID: id });
                db.deleteRows("orders", row => row.customer_id === id);
                db.commit();
            }
            loadCustomers();
            loadOrders();
            updateCustomerSelect();
        }

        // آپدیت سلکت مشتری‌ها
        async function updateCustomerSelect() {
            let customers;
            if (USE_API) {
                const res = await fetch(`${API_BASE}/api/customers`);
                customers = await res.json();
            } else {
                customers = db.queryAll("customers");
            }
            const select = document.getElementById('customerSelect');
            select.innerHTML = '<option value="">انتخاب مشتری</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id || customer.ID;
                option.textContent = `${customer.first_name} ${customer.last_name} (${customer.phone})`;
                select.appendChild(option);
            });
        }

        // لود سفارش‌ها
        async function loadOrders() {
            let orders;
            if (USE_API) {
                const res = await fetch(`${API_BASE}/api/orders`);
                orders = await res.json();
            } else {
                orders = db.queryAll("orders", { sort: [["date", "DESC"]] });
                // نام مشتری رو join کن
                orders.forEach(order => {
                    const customer = db.queryAll("customers", { query: { ID: order.customer_id } })[0] || { first_name: 'نامشخص', last_name: '' };
                    order.customer_name = `${customer.first_name} ${customer.last_name}`;
                });
            }
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';
            orders.forEach(order => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${order.id || order.ID}</td>
                    <td>${order.customer_name || order.first_name + ' ' + order.last_name}</td>
                    <td>${order.description}</td>
                    <td>${order.amount} تومان</td>
                    <td>${order.date}</td>
                `;
            });
        }

        // اضافه سفارش (دستی)
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const customerId = document.getElementById('customerSelect').value;
            const desc = document.getElementById('orderDesc').value;
            const amount = document.getElementById('orderAmount').value;
            const date = document.getElementById('orderDate').value;
            if (!customerId) return alert('لطفاً مشتری انتخاب کنید!');
            if (USE_API) {
                await fetch(`${API_BASE}/api/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customer_id: customerId, description: desc, amount: parseInt(amount), date })
                });
            } else {
                const id = 'manual_' + Date.now();
                db.insert("orders", { ID: id, customer_id: customerId, description: desc, amount: parseInt(amount), date: date });
                db.commit();
            }
            loadOrders();
            this.reset();
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
        });

        // شروع
        initDB();
    </script>
</body>
</html>
